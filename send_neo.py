# page_to_json.py 에서 all_results 가져와서 할당해야
all_results=[{'company': '크래프톤', 'broker': 'SK증권', 'analyst': '남효지', 'report_title': '그저 놀라울 뿐', 'publication_date': '2025-04-30', 'target_price': 500000, 'rating': '매수(유지)', 'metrics': [{'name': '매출액', 'value': 2710, 'unit': '십억원', 'period': '2024F', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 3273, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 3857, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 4301, 'unit': '십억원', 'period': '2027E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1182, 'unit': '십억원', 'period': '2024F', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1472, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1782, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 2018, 'unit': '십억원', 'period': '2027E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '순이익(지배주주)', 'value': 1306, 'unit': '십억원', 'period': '2024F', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '순이익(지배주주)', 'value': 1182, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '순이익(지배주주)', 'value': 1404, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '순이익(지배주주)', 'value': 1605, 'unit': '십억원', 'period': '2027E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 27263, 'unit': '원', 'period': '2024F', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 24671, 'unit': '원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 29297, 'unit': '원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 33492, 'unit': '원', 'period': '2027E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 8742, 'unit': '억원', 'period': '1Q25', 'yoy_growth': '31.3%', 'qoq_growth': '41.6%', 'type': 'actual'}, {'name': '영업이익', 'value': 4573, 'unit': '억원', 'period': '1Q25', 'yoy_growth': '47.3%', 'qoq_growth': '112.2%', 'type': 'actual'}, {'name': '당기순이익', 'value': 4989, 'unit': '억원', 'period': '1Q25', 'yoy_growth': '7.2%', 'qoq_growth': '-17.2%', 'type': 'actual'}], 'page': 1}, {'company': '크래프톤', 'broker': 'SK증권', 'analyst': None, 'report_title': None, 'publication_date': None, 'target_price': None, 'rating': None, 'metrics': [{'name': '매출액', 'value': 665.9, 'unit': '십억원', 'period': '1Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 707.0, 'unit': '십억원', 'period': '2Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 719.3, 'unit': '십억원', 'period': '3Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 617.6, 'unit': '십억원', 'period': '4Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 874.2, 'unit': '십억원', 'period': '1Q25', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 711.5, 'unit': '십억원', 'period': '2Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 876.5, 'unit': '십억원', 'period': '3Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 810.8, 'unit': '십억원', 'period': '4Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 2709.8, 'unit': '십억원', 'period': '2024', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 3273.0, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 3857.0, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 243.7, 'unit': '십억원', 'period': '1Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 191.3, 'unit': '십억원', 'period': '2Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 274.3, 'unit': '십억원', 'period': '3Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 232.6, 'unit': '십억원', 'period': '4Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 323.5, 'unit': '십억원', 'period': '1Q25', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 251.9, 'unit': '십억원', 'period': '2Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 362.1, 'unit': '십억원', 'period': '3Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 287.3, 'unit': '십억원', 'period': '4Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 941.9, 'unit': '십억원', 'period': '2024', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 1224.9, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': 'PC', 'value': 1436.1, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 402.3, 'unit': '십억원', 'period': '1Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 499.9, 'unit': '십억원', 'period': '2Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 425.4, 'unit': '십억원', 'period': '3Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 362.2, 'unit': '십억원', 'period': '4Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 532.4, 'unit': '십억원', 'period': '1Q25', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 442.2, 'unit': '십억원', 'period': '2Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 493.7, 'unit': '십억원', 'period': '3Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 481.9, 'unit': '십억원', 'period': '4Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 1689.8, 'unit': '십억원', 'period': '2024', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 1950.1, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '모바일', 'value': 2247.7, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 11.5, 'unit': '십억원', 'period': '1Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 8.8, 'unit': '십억원', 'period': '2Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 11.8, 'unit': '십억원', 'period': '3Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 12.3, 'unit': '십억원', 'period': '4Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 13.1, 'unit': '십억원', 'period': '1Q25', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 9.0, 'unit': '십억원', 'period': '2Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 12.0, 'unit': '십억원', 'period': '3Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 32.9, 'unit': '십억원', 'period': '4Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 44.3, 'unit': '십억원', 'period': '2024', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 67.0, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '콘솔', 'value': 136.1, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 355.4, 'unit': '십억원', 'period': '1Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 374.9, 'unit': '십억원', 'period': '2Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 394.9, 'unit': '십억원', 'period': '3Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 402.1, 'unit': '십억원', 'period': '4Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 416.9, 'unit': '십억원', 'period': '1Q25', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 406.8, 'unit': '십억원', 'period': '2Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 478.3, 'unit': '십억원', 'period': '3Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 498.8, 'unit': '십억원', 'period': '4Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 1527.3, 'unit': '십억원', 'period': '2024', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 1800.8, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업비용', 'value': 2074.9, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 310.5, 'unit': '십억원', 'period': '1Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 332.1, 'unit': '십억원', 'period': '2Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 324.4, 'unit': '십억원', 'period': '3Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 215.5, 'unit': '십억원', 'period': '4Q24', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 457.3, 'unit': '십억원', 'period': '1Q25', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 304.7, 'unit': '십억원', 'period': '2Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 398.2, 'unit': '십억원', 'period': '3Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 312.0, 'unit': '십억원', 'period': '4Q25E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1182.5, 'unit': '십억원', 'period': '2024', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1472.2, 'unit': '십억원', 'period': '2025E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1782.1, 'unit': '십억원', 'period': '2026E', 'yoy_growth': None, 'qoq_growth': None, 'type': 'forecast'}], 'page': 2}, {'company': '크래프톤', 'broker': 'SK증권', 'analyst': None, 'report_title': None, 'publication_date': None, 'target_price': None, 'rating': None, 'metrics': [{'name': '매출액', 'value': 3273, 'unit': '십억원', 'period': '2025E', 'yoy_growth': '20.8%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 3857, 'unit': '십억원', 'period': '2026E', 'yoy_growth': '17.8%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '매출액', 'value': 4301, 'unit': '십억원', 'period': '2027E', 'yoy_growth': '11.5%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1472, 'unit': '십억원', 'period': '2025E', 'yoy_growth': '24.5%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 1782, 'unit': '십억원', 'period': '2026E', 'yoy_growth': '21.1%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '영업이익', 'value': 2018, 'unit': '십억원', 'period': '2027E', 'yoy_growth': '13.2%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '세전계속사업이익', 'value': 1644, 'unit': '십억원', 'period': '2025E', 'yoy_growth': '-4.6%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '세전계속사업이익', 'value': 2015, 'unit': '십억원', 'period': '2026E', 'yoy_growth': '22.6%', 'qoq_growth': None, 'type': 'forecast'}, {'name': '세전계속사업이익', 'value': 2269, 'unit': '십억원', 'period': '2027E', 'yoy_growth': '12.6%', 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EBITDA', 'value': 1571, 'unit': '십억원', 'period': '2025E', 'yoy_growth': '21.9%', 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EBITDA', 'value': 1886, 'unit': '십억원', 'period': '2026E', 'yoy_growth': '20.0%', 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EBITDA', 'value': 2116, 'unit': '십억원', 'period': '2027E', 'yoy_growth': '12.2%', 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 24671, 'unit': '원', 'period': '2025E', 'yoy_growth': '-9.5%', 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 29297, 'unit': '원', 'period': '2026E', 'yoy_growth': '18.8%', 'qoq_growth': None, 'type': 'forecast'}, {'name': 'EPS', 'value': 33492, 'unit': '원', 'period': '2027E', 'yoy_growth': '14.3%', 'qoq_growth': None, 'type': 'forecast'}], 'page': 4}, {'company': '크래프톤', 'broker': 'SK증권', 'analyst': '남효지', 'report_title': None, 'publication_date': '2025-02-12', 'target_price': 500000, 'rating': '매수', 'metrics': [], 'page': 5}]

from neo4j import GraphDatabase
# ✅ Step 3: Neo4j 연결 설정 (수정 필요)s
uri = "수정"
user = "neo4j"
password = "키"
driver = GraphDatabase.driver(uri, auth=(user, password))

# ✅ Step 4: 기존 노드 삭제
# def delete_old(tx):
#     tx.run("MATCH (n) DETACH DELETE n")

# with driver.session() as session:
#     session.execute_write(delete_old)

def insert_report(record):
    with driver.session() as session:
        session.run("""
        MERGE (c:Company {name: $company})
        MERGE (b:Broker {name: $broker})
        MERGE (a:Analyst {name: $analyst})
        CREATE (r:Report {
            title: $title,
            publication_date: $date,
            target_price: $target_price,
            rating: $rating
        })
        MERGE (a)-[:WRITES]->(r)
        MERGE (r)-[:ISSUED_BY]->(b)
        MERGE (r)-[:TARGETS]->(c)
        """, company=record["company"], broker=record["broker"],
            analyst=record["analyst"] or "Unknown",
            title=record["report_title"] or "Untitled",
            date=record["publication_date"] or "Unknown",
            target_price=record["target_price"], rating=record["rating"])


def insert_metrics(record,_report_title):
    with driver.session() as session:
        for m in record["metrics"]:
            session.run("""
            MERGE (m:Metric {name: $metric_name})
            CREATE (f:Forecast {
                unit: $unit,
                value: $value,
                period: $period,
                yoy_growth: $yoy,
                qoq_growth: $qoq,
                type: $type
            })
            MERGE (c:Company {name: $company})
            MERGE (r:Report {title: $report_title})
            MERGE (f)-[:OF_METRIC]->(m)
            MERGE (c)-[:HAS_FORECAST]->(f)
            MERGE (r)-[:FORECASTS]->(f)
            """, metric_name=m["name"], value=m["value"], unit=m["unit"], period=m["period"],
                yoy=m.get("yoy_growth"), qoq=m.get("qoq_growth"), type=m.get("type", "forecast"),
                company=record["company"], report_title=_report_title)


insert_report(all_results[0])

for record in all_results:
    if record["metrics"]:
        insert_metrics(record,all_results[0]["report_title"])